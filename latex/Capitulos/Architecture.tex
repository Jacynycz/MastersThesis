
\chapter{Architecture}

\begin{FraseCelebre}
  \begin{Frase}
    There is no secret ingredient. To make something special you just have to
    believe it's special.
  \end{Frase}
  \begin{Fuente}
    Mr. Ping - Kung Fu Panda
  \end{Fuente}
\end{FraseCelebre}

The platform's architecture consists in two main parts as explained in section
\ref{tech}, a decentralized file system in which users can upload all the files
using IPFS (see section \ref{tech:sec:ipfs}), and a smart contact to register
all interactions of the users with the platform (see section
\ref{tech:sec:ethereum:sm}).

As a decentralized technology, anyone can run a node locally, connecting to the
IPFS network and to the Ethereum's blockchain to interact with the platform, but
this technology is not used commonly, and not all users have the knowledge to
install and run these programs. As a solution, a ``gateway server'' to test the
platform's implementation was created, using an web browser extension called
Metamask\footnote[1]{https://metamask.io/} to interact with the blockchain and
running an IPFS node to upload the files as explained in the diagram of the
figure \ref{plat:sec:architecture:diagram}.

\figura{architecture.png}{width=0.9\linewidth}{plat:sec:architecture:diagram}{Architecture
  diagram of a node with IPFS and an Ethereum light client}

\section{Smart Contract Architecture}
\label{arch:sca}
Smart contracts in Ethereum can interact with each other, creating an ecosystem
of programs that resemble object oriented programming. The contract structure
and source code is crucial because once a contract is in the blockchain, there
is no way to change it.

One of the most important challenges in designing a contract is to reduce the
cost of transactions, since the cost of these can be very high if the contract
design is inefficient~\cite{croman2016scaling}. Inserting data in the blockchain
is very expensive, so it is advisable to use the data structures that Ethereum
offers to reduce the transaction cost. Section~\ref{arch:trans} discusses the
problems encountered during the development of the platform to reduce these
costs and what solutions have been implemented.

\figura{contracts.png}{width=0.93\linewidth}{contracts:uml}{Diagrama UML del la
  estructura de contratos}

The design of the platform has been fragmented into 4 smart contracts that allow
both reduce the cost of transactions, and fragment the information of the
platform, as seen in figure \ref{contracts:uml}. This fragmentation allows other
smart contracts interact with the information stored in Decentralized Science,
without having to rely on a single contract that centralizes all the
transactions, possibly causing a significant number of transactions to the same
address.

\subsection*{Decentralized Journal}%

This is the contract from which all interactions with authors and publishers are
controlled. The authors interact with this contract to send the papers, and the
editors assign reviewers for the peer review process.

This contract has a series of ethereum addresses associated with the editors
(which are the ones who can assign reviewers) and a reference to the contract
address of the ``library contract'', where the papers are sent. In addition,
through this contract, the reviewers send the reviews that have been assigned to
them.

\subsection*{Decentralized Library}

This smart contract stores the IPFS addresses of the papers and the reviews and
controls if the papers are published.

To store this data, this contract saves a reference to the IPFS addresses in
\emph{Base58}. This reference is the result of the data transformation is
explained in the section~\ref{arch:trans}.

Then it stores this data in a struct called ``Multihash'' defined in the smart
contract and performs a hash function to obtain an identifier of the file within
the system, which is much more efficient in Ethereum. This hash is the one that
will be used to identify a paper from the other Decentralized
Science's contracts.

In addition, each paper stores all the revisions it has through a ``Review''
struct. This struct has an IPFS address with the review (transformed as a
\emph{Multihash}), the address of the reviewer and an integer representing
whether the paper is accepted or not.

\subsection*{Rating Storage}

This smart contract stores all the transactions about the ratings of the reviews
made by the reviewers, and it is the one capable to give reputation to each one
of them.

Each ratring is represented by a struct that has: a hash that univocally
identifies the review of a paper made by a reviewer, the address of the person
making the rating and a score that represents the reputation that is given to
the reviewer.

Regarding the reputation system, it was decided to adopt a five-star reputation
system explained in the section \ref{rep:system}.

\subsection*{ReviewersHub}

It is responsible for storing the addresses, the research fields, and the
reputation of the reviewers who are registered in the platform.

It is responsible for storing the addresses, the research fields, and the
reputation of the reviewers who are registered in the platform. This contract is
used by: the Rating Storage contract to give the reputation scores to the
reviewers, the new reviewers who want to register on the platform and the
editors who want to find new reviewers to carry out the peer review process.

The diagram \ref{contracts: uml} tries to illustrate the structure of the
contracts through a UML, as if the smart contracts of Ethereum were
objects.


\section{Reputation system}
\label{rep:system}

Of the many reputation systems discussed in section \ref{soa:rs}, a five-star
rating has been decided for the platform~\cite{kinateder2003architecture}. This
reputation system is present in many online platforms such as
Tripadvisor\footnote{https://www.tripadvisor.com/},
Amazon\footnote{https://www.amazon.com/}, Google
Play\footnote{https://play.google.com/} and other large platforms in which
products and services are voted by users.

Being implemented in the blockchain implies that all interactions are public and
auditable. Everyone can see who has voted which revision and with what score or
rating, so it is a system in which there is no anonymity. This allows dissuading
the problems commented in section \ref{soa:rs} since the users who carry out
unjust directing or rating attacks are exposed publicly in the network. But this
also raises concerns about privacy and anonymity, commented in section
\ref{sec:privacyReview}.

The internal operating mode has several simple steps:
\begin{enumerate}
\item When making a review, a hash is created in the system
  (SHA-3~\cite{aumasson2008sha}) with: the address of the reviewer, the address
  of the paper it reviews and the address of the journal that assigned the
  review. This hash uniquely identifies the review within the system.
  
\item Both authors, editors and the other reviewers of the paper have the
  ability to assign a score from 1 to 5 indicating whether they think the review
  is fair or not.
  
\item For each vote, the system registers the voter and sends him the reputation
     the reviewer, making an exponential smoothing of all the votes that he has
     received~\cite{gardner1985exponential}.
\end{enumerate}

When deciding whether a review is fair or not there are several points of
view~\cite{daniel1993guardians,cole1979fair} and not all people will agree, but
offering guidelines for the community can be an initial solution to make all the
votes in the system as fair as possible.

Within a reputation system there will always be some controversy and there will
always be methods to placate it~\cite{dellarocas2000immunizing}, but the design presented in this work is a
proof of concept that will evolve as new systems are designed to appease the
problems that have arisen.


\section{Functional requirements and activity diagrams}

In the following section we will discuss the functional requirements and the
activity diagrams for each transaction users can make to interact with the
platform:


\figuraAD{AD1}% 1. Table ID
{Send Paper}% 2. Table title
{The user uploads a file to IPFS and creates an Ethereum
  transaction}% 3. Table description
{Authors' addresses and a file}% 4. Inputs
{IPFS address of the paper}% 5. Outputs
{Authors' Ethereum addresses and Metamask installed}% 6. Requirements
{The journal's contract address exists and the IPFS node is
  online}% 7. Preconditions
{There is a transaction to the journal's contract address with the information\\
  & about the authors and the IPFS address of the paper }% 8. Postconditions
{sending a paper}% 9. Caption description

\figuraAD{AD2}% 1. Table ID
{Assign Reviewer}% 2. Table title
{An editor assigns reviewers for a paper}% 3. Table description
{Ethereum's addresses of the reviewers}% 4. Inputs
{_}% 5. Outputs
{The journal's contract address exists} {The address has editor permissions and
  there is a paper pending}% 6. Requirements
{A transaction is created to assign the reviwers}% 7. Preconditions
{assigning a reviewer}% 9. Caption description

\figuraAD{AD3}% 1. Table ID
{Accept Review task}% 2. Table title
{An address authorized as a reviewer accepts the review
  task}% 3. Table description
{A boolean accepting the task}% 4. Inputs
{_}% 5. Outputs
{The journal's contract address exists}% 6. Requirements
{There are a petition pending for the reviewers address}% 7. Preconditions
{The petition is accepted and there is a deadline to submit the
  review}% 8. Postconditions
{accepting a review}% 9. Caption description

\figuraAD{AD4}% 1. Table ID
{Send Review}% 2. Table title
{A reviewers submits the review previously accepted via
  IPFS}% 3. Table description
{A file containing the review}% 4. Inputs
{The IPFS address of the review}% 5. Outputs
{The journal's contract address exists}% 6. Requirements
{The submission is within the deadline}% 7. Preconditions
{There is a transaction to the journal's contract address}% 8. Postconditions
{sending a review}% 9. Caption description

\figuraAD{AD5}% 1. Table ID
{Rate Review}% 2. Table title
{The authorized address submits a rating about a review}% 3. Table description
{An integer from 1 to 5}% 4. Inputs
{_}% 5. Outputs
{The journal's contract address exists}% 6. Requirements
{The address can submit a review and has not done it yet}% 7. Preconditions
{The reputation of the reviewer is affected by de rating}% 8. Postconditions
{rating a review}% 9. Caption description
% \clearpage
\section{Transaction costs}
\label{arch:trans}

As explained in the section \ref{tech:sec:ethereum} Ethereum's smart contracts
are transaction-based. Each interaction with the platform is registered in the
blockchain with a transaction. The architecture of this platform allows the
following transactions (all the costs are estimated\footnote{Check
  https://ethgasstation.info/ for more info about transaction costs}).

\begin{itemize}
  \itbf{Create the platform:} To create Decentralized Science, there must be an
  initial transaction with the source code to upload it to the blockchain.
  Normally this transaction is the most expensive, and is only necessary to do
  it once.

  This transaction creates all the contracts mentioned in the section
  \ref{arch:sm} and outputs the Ethereum's address of the platform. The gas
  amount required to this transaction is 1696291, approximately from 2 to 4
  euros.

  \itbf{Send Paper:} To send a paper the user have to send a transaction
  containing the Ethereum addresses of the authors and a file containing the
  paper. This file will be uploaded to IPFS through a node and then the
  resulting address will be inserted in the transaction. The gas amount required
  to do this transaction is 114812, around 0.30 euros.

  \itbf{Assign reviewers:} Assigning the reviewers is normally very cheap
  because an address authorized as ``editor'' must create a simple transaction
  with the paper identifier and the addresses of the reviewers. The gas amount
  required to do this transaction is 58707, around 0.10 euros.

  \itbf{Accept review:} This is the cheapest interaction with the platform, a
  reviewer must accept the task of reviewing a paper through a transaction. With
  this system, the reviewer cryptographically signs the contract and compromises
  to review the paper. The gas amount required to do this transaction is 23971,
  around 0.04 euros.

  \itbf{Send Review:} Sending a review is also expensive, because the review is
  also a file and must be uploaded to IPFS. The transaction also contains a
  reference to the paper, and an integer representing the acceptance level of
  the review. The gas amount required to do this transaction is 149760, around
  0.35 euros.

  \itbf{Send Rating:} This transaction contains a reference to the review of a
  paper, and an integer from 1 to 5 representing the rating of a review. This
  transaction initially can only be made by the other reviewers, the authors and
  the editors of the journal. The gas amount required to do this transaction is
  94122, around 0.04 euros.

\end{itemize}

\subsection{Reducing transaction costs}
In Ethereum, reducing the transaction costs is critical, because all
interactions have costs to the user. In Decentralized Science's contract the
following actions have been taken to reduce these costs:

\begin{itemize}
  \itbf{Reduce the amount of data stored in the blockchain:} Storing data in the
  blockchain is slow and expensive, so the platform only registers the minimum
  amount of data necessary to verify the interactions between users. All data
  files are stored in IPFS and the addresses are saved in Ethereum. \itbf{Avoid
    expensive data types:} Working with ``Strings'' in \ii{Solidity} is very
  expensive, that's why it is recommended to avoid using this data type.

  As described in the previous sections. Decentralized Science stores IPFS
  addresses as links between Ethereum and IPFS, but these addresses are
  \ii{Base58} strings, a data type not implemented yet in Ethereum. This address
  has 3 parts: 1) A number representing a hash function, 2) another number
  representing the size of the file and 3) a hashed string of the data done with
  the 1) hash function.

  To save an IPFS address in Ethereum, initially a ``String'' data type was
  used. But to avoid using this type, first the \ii{Base58} is decoded into the
  three parts mentioned above. Finally instead of creating a transaction with a
  string representing the IPFS address, the transaction contains the hash ID
  (using an \emph{uint8} data tyoe), the size (using an \emph{uint8} data type)
  and the hashed data (using \emph{bytes32} data type). This allows the platform
  to reduce the transactions involving a file upload around $40\%$.
\end{itemize}


